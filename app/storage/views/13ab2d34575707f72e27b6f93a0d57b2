	<!-- BEGIN PICKERS LEVEL STYLES -->
	<link rel="stylesheet" type="text/css" href="/assets/global/plugins/clockface/css/clockface.css"/>
	<link rel="stylesheet" type="text/css" href="/assets/global/plugins/bootstrap-datepicker/css/datepicker3.css"/>
	<link rel="stylesheet" type="text/css" href="/assets/global/plugins/bootstrap-timepicker/css/bootstrap-timepicker.min.css"/>
	<link rel="stylesheet" type="text/css" href="/assets/global/plugins/bootstrap-colorpicker/css/colorpicker.css"/>
	<link rel="stylesheet" type="text/css" href="/assets/global/plugins/bootstrap-daterangepicker/daterangepicker-bs3.css"/>
	<link rel="stylesheet" type="text/css" href="/assets/global/plugins/bootstrap-datetimepicker/css/bootstrap-datetimepicker.css"/>
	<link rel="stylesheet" type="text/css" href="/assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.css"/>
	<!-- END PICKERS LEVEL STYLES -->

	<!-- BEGIN PAGE LEVEL STYLES -->
	<link href="/assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.css" rel="stylesheet" type="text/css"/>
	<link href="/assets/admin/pages/css/profile-old.css" rel="stylesheet" type="text/css"/>
	<!-- END PAGE LEVEL STYLES -->

	<!-- BEGIN PAGE LEVEL STYLES -->
	<link rel="stylesheet" type="text/css" href="/assets/global/plugins/select2/select2.css"/>
	<link href="/assets/admin/pages/css/todo.css" rel="stylesheet" type="text/css"/>
	<!-- END PAGE LEVEL STYLES -->
	<!-- BEGIN PAGE LEVEL STYLES -->
	<link rel="stylesheet" type="text/css" href="/assets/global/plugins/bootstrap-wysihtml5/bootstrap-wysihtml5.css"/>
	<link rel="stylesheet" type="text/css" href="/assets/global/plugins/bootstrap-markdown/css/bootstrap-markdown.min.css">
	<link rel="stylesheet" type="text/css" href="/assets/global/plugins/bootstrap-summernote/summernote.css">

	<link rel="stylesheet" type="text/css" href="/assets/global/plugins/bootstrap-datepicker/css/datepicker3.css"/>
	<!-- END PAGE LEVEL STYLES -->

	<div class="row">
		<div class="col-md-12">
			<!-- BEGIN PORTLET -->

			<div class="portlet light" data-lesson="<?php echo Hashids::encode($lesson->id); ?>">
				<!-- STAT -->
				<div class="row list-separated profile-stat">
					<img class="col-md-12" src="<?php echo $course->cover_picture; ?>"/>
				</div>
				<!-- END PAGE CONTENT INNER -->
				<div class="row">
					<div class="col-md-12">
						<div class="portlet-title">
							<h4 class="profile-usertitle-name"><?php echo $lesson->title; ?>

								<a href="javascript:;" class="btn blue-madison pull-right tooltips lessons-back-btn" data-placement="left" data-original-title="Ir al listado de Lecciones">
									<i class="fa fa-arrow-left"></i>
								</a>
								<span class="pull-right">&nbsp;</span>
								<span class="pull-right">&nbsp;</span>
								<!--
								<a href="javascript:;" class="btn yellow pull-right tooltips discussion-edit" data-placement="left" data-original-title="Comentarios de DiscusiÃ³n">
									<i class="fa fa-pencil"></i>
								</a>
								-->
							</h4>
						</div>
					</div>
					<div class="col-md-12">
						<?php echo $lesson->content; ?>

					</div>
					<div class="col-md-12">&nbsp;</div>
					<div class="col-md-12">&nbsp;</div>
					<div class="col-md-12">
						<div class="tabbable-custom nav-justified">
							<ul class="nav nav-tabs nav-justified">
								<li class="active" style="text-align:center;">
									<div class="btn" href="#tab_1" data-toggle="tab">
									Comentarios (<?php echo $lesson->discussions->count(); ?>)</div>
								</li>
								<li style="text-align:center;">
									<div class="btn" href="#tab_2" data-toggle="tab">
									Archivos Adjuntos (<?php echo $lesson->attachments->count(); ?>)</div>
								</li>
								<li style="text-align:center;">
									<div class="btn" href="#tab_3" data-toggle="tab">
									Enlaces (<?php echo $lesson->countValidLinks(); ?>)</div>
								</li>
								<li style="text-align:center;">
									<div class="btn" href="#tab_4" data-toggle="tab">
									Actividades (<?php echo $lesson->evaluations->count(); ?>)</div>
								</li>
								<!-- <li style="text-align:center;">
									<div class="btn" href="#tab_5" data-toggle="tab">
									Mis notas (<span id="my-notes-counter"><?php echo $lesson->myNotes()->count(); ?></span>)</div>
								</li> -->
							</ul>
							<div class="tab-content">
								<div class="tab-pane active" id="tab_1">
									<?php $comments = $lesson->discussions; ?>
									<div class="row discussions"> 
										<div class="form-group">
											<div class="col-md-12">
												<ul class="media-list">
													<?php if($comments->count() > 0): ?>
														<?php foreach($comments as $comment): ?>
															<?php if(!$comment->isBanned()): ?>
															    <!-- Vista Profesor puede visualizar todos los comentarios -->
															    <!-- Vista Estudiante solo puede visualizar los comentarios no Banneados -->
																<?php $comment_user = $comment->author; ?>
																<?php $attachments = $comment->attachments; ?>
																<?php $thumbsups = $comment->thumbsups; ?>
																<?php $replies = $comment->children; ?>
																<li class="media <?php echo $comment->isBanned() ? 'banned' : ''; ?>" data-comment="<?php echo Hashids::encode($comment->id); ?>">
																	<a class="pull-left" href="javascript:;">
																	<img class="todo-userpic" src="<?php echo $comment_user->profile->getAvatar(); ?>" width="45px" height="45px">
																	</a>
																	<div class="media-body todo-comment">
																		<p class="todo-comment-head">
																			<span class="todo-comment-username"><?php echo $comment_user->display_name; ?></span> &nbsp; 
																			<span class="todo-comment-date moment-fromnow"><?php echo $comment->created_at; ?></span> &nbsp; 
																			<?php if($attachments->count() > 0): ?>
																				<?php $attachment = $comment->attachments->first() ?>
																				<a href="javascript:;" class="btn font-blue-chambray tooltips download-attachment-btn" data-original-title="Descargar archivo adjunto (<?php echo $attachment->getSize(); ?>)" data-attachment="<?php echo Crypt::encrypt($attachment->id); ?>"><i class="fa fa-paperclip"></i></a> &nbsp; 
																			<?php endif; ?>
																			<!-- <a href="javascript:;" class="btn <?php echo $comment->hasThumbsup(Auth::user()->id) ? 'font-blue' : 'font-blue-chambray'; ?> tooltips comment-like-btn" data-original-title="<?php echo $thumbsups->count(); ?> Me gusta. <?php echo $comment->peopleThumbsupIt(); ?>"><i class="fa fa-thumbs-up"></i> <span class="thumbsups-counter"><?php echo $thumbsups->count(); ?></span></a> &nbsp; 
																			<a href="javascript:;" class="btn font-blue-chambray tooltips comment-reply-btn" data-original-title="<?php echo $replies->count(); ?> Respuestas"><i class="fa fa-comments-o"></i> <span class="replies-counter"><?php echo $replies->count(); ?></span></a> -->
																		</p>
																		<div class="todo-text-color">
																			 <?php echo $comment->content; ?> <br>
																		</div>
																		<div class="children-comments">
																			<?php if($replies->count() > 0): ?>
																				<?php foreach($replies as $reply): ?>
																					<?php if(!$reply->isBanned()): ?>
																						<?php $comment_user = $reply->author; ?>
																						<?php $attachments = $reply->attachments; ?>
																						<?php $thumbsups = $reply->thumbsups; ?>
																						<?php $replies = $reply->children; ?>
																						<div class="media <?php echo $reply->isBanned() ? 'banned' : ''; ?>" data-comment="<?php echo Hashids::encode($reply->id); ?>">
																							<a class="pull-left" href="javascript:;">
																							<img class="todo-userpic" src="<?php echo $comment_user->profile->getAvatar(); ?>" width="45px" height="45px">
																							</a>
																							<div class="media-body">
																								<p class="todo-comment-head">
																									<span class="todo-comment-username"><?php echo $comment_user->display_name; ?></span> &nbsp; 
																									<span class="todo-comment-date moment-fromnow"><?php echo $reply->created_at; ?></span> &nbsp; 
																									<?php if($attachments->count() > 0): ?>
																										<?php $attachment = $reply->attachments->first() ?>
																										<a href="javascript:;" class="btn font-blue-chambray tooltips download-attachment-btn" data-original-title="Descargar archivo adjunto (<?php echo $attachment->getSize(); ?>)"  data-attachment="<?php echo Crypt::encrypt($attachment->id); ?>"><i class="fa fa-paperclip"></i></a> &nbsp; 
																									<?php endif; ?>
																									<!-- <a href="javascript:;" class="btn <?php echo $reply->hasThumbsup(Auth::user()->id) ? 'font-blue' : 'font-blue-chambray'; ?> tooltips comment-like-btn" data-original-title="<?php echo $reply->thumbsups->count(); ?> Me gusta. <?php echo $reply->peopleThumbsupIt(); ?>"><i class="fa fa-thumbs-up"></i> <span class="thumbsups-counter"><?php echo $reply->thumbsups->count(); ?></span></a> &nbsp;
																									<?php if($reply->isMine()): ?>
																										<a href="javascript:;" class="btn font-grey-silver tooltips comment-edit-btn pull-right" data-original-title="Editar"><i class="fa fa-pencil"></i></a>
																										<a href="javascript:;" class="btn font-grey-silver tooltips comment-delete-btn pull-right" data-original-title="Eliminar"><i class="fa fa-trash-o"></i></a>
																									<?php else: ?>
																										<?php if($reply->isMarkedAsBanned()): ?>
																											Solo los profesores pueden ver esto
																											<a href="javascript:;" class="btn font-red tooltips comment-ban-btn pull-right" data-original-title="Marcado como no deseado por <?php echo $reply->peopleBannedIt(); ?>"><i class="fa fa-ban"></i></a>
																										<?php else: ?>
																											<a href="javascript:;" class="btn font-grey-silver tooltips comment-ban-btn pull-right" data-original-title="No deseo ver esto"><i class="fa fa-ban"></i></a>
																										<?php endif; ?>
																									<?php endif; ?> -->
																								</p>
																								<div class="todo-text-color">
																									 <?php echo $reply->content; ?>

																								</div>
																							</div>
																						</div>
																					<?php endif; ?>
																				<?php endforeach; ?>
																			<?php endif; ?>															
																		</div>
																	</div>
																</li>
															<?php endif; ?>
														<?php endforeach; ?>
													<?php else: ?>
														<div class="row">
															<div class="col-md-12">
																Todavia no hay archivos adjuntos para esta lecciÃ³n
															</div>
														</div>
													<?php endif; ?>
													<!-- <li class="media">
														<a class="pull-left" href="javascript:;">
															<img class="todo-userpic" src="<?php echo Auth::user()->profile->getAvatar(); ?>" width="45px" height="45px">
														</a>
														<div class="media-body">
															<form class="comment-form-ajax" enctype="multipart/form-data">
																<input type="hidden" name="lesson_id" value="<?php echo Hashids::encode($lesson->id); ?>"/>
																<input type="hidden" name="parent_id" value="<?php echo Hashids::encode(0); ?>"/>
																<div class="reply-textarea-content">
																	<textarea class="summernote" rows="1" placeholder="Escribe un comentario..." name="comment"></textarea>
																</div>
																<div class="reply-submit-btn">
																	<a href="javascript:;" class="pull-right btn btn-sm btn-circle green-haze comment-form-btn"> &nbsp; Enviar &nbsp; </a>
																	<span class="pull-right"> &nbsp; </span>
																	<div class="pull-right fileinput fileinput-new" data-provides="fileinput">
																		<span class="btn default btn-file btn-sm btn-circle green-haze">
																			<span class="fileinput-new">AÃ±adir Adjunto </span>
																			<span class="fileinput-exists"> Cambiar </span>
																			<input type="file" name="attachment">
																		</span>
																		<span class="fileinput-filename"></span>&nbsp; 
																		<a href="#" class="close fileinput-exists" data-dismiss="fileinput"></a>
																	</div>
																</div>
															</form>
														</div>
													</li> -->
												</ul>
											</div>
										</div>
									</div>
								</div>
								<div class="tab-pane attachments" id="tab_2">
									<?php if($lesson->attachments->count() > 0): ?>
										<?php foreach($lesson->attachments as $attachment): ?>
											<div class="row" style="margin-bottom:5px">
												<div class="col-md-2">
													<img src="<?php echo $attachment->image(); ?>" width="50px">
												</div>
												<div class="col-md-8">
													<?php echo $attachment->name; ?> (<?php echo $attachment->getSize(); ?>)
												</div>
												<div class="col-md-2">
													<span class="btn blue-madison download-attachment-btn" data-attachment="<?php echo Crypt::encrypt($attachment->id); ?>">Descargar <i class="fa fa-download"></i></span>
												</div>
											</div>
										<?php endforeach; ?>
									<?php else: ?>
										<div class="row">
											<div class="col-md-12">
												Todavia no hay archivos adjuntos para esta lecciÃ³n
											</div>
										</div>
									<?php endif; ?>
								</div>
								<div class="tab-pane" id="tab_3">
									<?php if($lesson->links->count() > 0): ?>
										<?php foreach($lesson->links as $link): ?>
											<?php if($link->title != '' AND $link->title != null AND $link->url != '' AND $link->url != null): ?>
												<div class="row" style="margin-bottom:5px">
													<div class="col-md-10">
														<?php echo $link->title; ?>

													</div>
													<div class="col-md-2">
														<a href="<?php echo $link->url; ?>" target="_blank" class="btn blue-madison">Ir <i class="fa fa-external-link"></i></a>
													</div>
												</div>
											<?php endif; ?>
										<?php endforeach; ?>
									<?php else: ?>
										<div class="row">
											<div class="col-md-12">
												Todavia no hay enlace relacionados de esta lecciÃ³n
											</div>
										</div>
									<?php endif; ?>
								</div>
								<div class="tab-pane" id="tab_4">
									<?php if($lesson->evaluations->count() > 0): ?>
									<div class="col-md-12">
										<?php foreach($lesson->evaluations as $evaluation): ?>
											<div class="row portfolio-block activity-block" data-activity="<?php echo Hashids::encode($evaluation->id); ?>">
												<div class="col-md-5">
													<div class="portfolio-text">
														<img src="<?php echo $evaluation->image(); ?>" alt="" style="max-width:100px" />
														<div class="portfolio-text-info">
															<h4><?php echo $evaluation->title != '' ? $evaluation->title : 'Sin nombre'; ?></h4>
															<p>
																<?php echo $evaluation->description != '' ? $evaluation->description : 'Sin descripciÃ³n'; ?>

															</p>
															<em>(<?php echo date('d/m/Y', strtotime($evaluation->date_start) ); ?> - <?php echo date('d/m/Y', strtotime($evaluation->date_end) ); ?>)</em>
														</div>
													</div>
												</div>
												<div class="col-md-7 portfolio-stat">
													<div class="portfolio-info col-md-3">
														Estudiantes <span>
														<?php echo $evaluation->tests->count(); ?> </span>
													</div>
													<div class="portfolio-info col-md-3">
														Promedio <span>
														<?php echo $evaluation->average(); ?>% </span>
													</div>
													<div class="portfolio-info col-md-3">
														Preguntas <span>
														<?php if($evaluation->type == 'hangman'): ?> <?php echo $evaluation->hangman->count(); ?>

														<?php elseif($evaluation->type == 'memory'): ?> <?php echo $evaluation->memory->count(); ?>

														<?php elseif($evaluation->type == 'rpsls'): ?> <?php echo $evaluation->rpsls->count(); ?>

														<?php elseif($evaluation->type == 'roulette'): ?> <?php echo $evaluation->roulette->count(); ?>

														<?php endif; ?>
														 </span>
													</div>
												</div>
												<?php if($evaluation->tests->count() > 0): ?>
													<div class="col-md-12 testers-btn" style="text-align:center;cursor:pointer;"><i class="fa fa-angle-double-down"></i></div>
													<div class="col-md-12 testers hidden">
														<?php foreach($evaluation->tests as $test): ?>
															<?php $tester = $test->author; ?>
															<div class="col-md-1">&nbsp;</div>
															<div class="col-md-4">
																<div class="portfolio-text">
																	<img src="<?php echo $tester->profile->getAvatar(); ?>" alt="" style="max-width:75px" />
																	<div class="portfolio-text-info">
																		<h4><?php echo $tester->display_name; ?></h4>
																		<p>
																			(<em class="timeago"><?php echo $test->updated_at; ?></em>)
																		</p>
																	</div>
																</div>
															</div>
															<div class="col-md-7 portfolio-stat">
																<div class="portfolio-info col-md-3">
																	Porcentaje <span>
																	<?php echo $test->percentage(); ?> </span>
																</div>
																<div class="portfolio-info col-md-3">
																	Preguntas Acertadas <span>
																	<?php echo $test->hits; ?> </span>
																</div>
																<div class="portfolio-info col-md-3">
																	Equivocaciones <span>
																	<?php echo $test->mistakes; ?> </span>
																</div>
																<div class="portfolio-info col-md-3">
																	DuraciÃ³n <span><?php echo $test->duration(); ?></span>
																</div>
															</div>
														<?php endforeach; ?>
													</div>
												<?php endif; ?>
											</div>
										<?php endforeach; ?>
									</div>
									<?php else: ?>
										<div class="row">
											<div class="col-md-12">
												Todavia no hay actividades para esta lecciÃ³n
											</div>
										</div>
									<?php endif; ?>
								</div>
								<div class="tab-pane" id="tab_5">
									<div class="row col-md-12"><div class="pull-right btn blue-madison tooltips notes-download-btn" data-original-title="Descargar mis Notas"><i class="fa fa-download"></i></div></div>
									<div class="row">&nbsp;</div>
									<?php $notes = $lesson->myNotes(); ?>
									<?php $avatar = Auth::user()->profile->getAvatar() ?>
									<div class="row notes"> 
										<div class="form-group">
											<div class="col-md-12">
												<ul class="media-list">
													<?php if($notes->count() > 0): ?>
														<?php foreach($notes as $note): ?>
														    <!-- Vista Profesor puede visualizar todos los comentarios -->
														    <!-- Vista Estudiante solo puede visualizar los comentarios no Banneados -->
															<li class="media " data-note="<?php echo Hashids::encode($note->id); ?>">
																<a class="pull-left" href="javascript:;">
																<img class="todo-userpic" src="<?php echo $avatar; ?>" width="45px" height="45px">
																</a>
																<div class="media-body todo-comment">
																	<p class="todo-comment-head">
																		<span class="todo-comment-username"><?php echo Auth::user()->display_name; ?></span> &nbsp; 
																		<span class="todo-comment-date moment-fromnow"><?php echo $note->created_at; ?></span> &nbsp; 
																		<a href="javascript:;" class="btn font-grey-silver tooltips note-edit-btn pull-right" data-original-title="Editar"><i class="fa fa-pencil"></i></a>
																		<a href="javascript:;" class="btn font-grey-silver tooltips note-delete-btn pull-right" data-original-title="Eliminar"><i class="fa fa-trash-o"></i></a>
																	</p>
																	<div class="todo-text-color">
																		 <?php echo $note->content; ?> <br>
																	</div>
																	<div class="children-comments">
																	</div>
																</div>
															</li>
														<?php endforeach; ?>
													<?php else: ?>
														<li class="btn yellow col-md-12 be-firts-comment" style="margin-bottom:15px">AquÃ­ puedes crear apuntes personales acerca de esta lecciÃ³n</li>
													<?php endif; ?>
													<li class="media">
														<a class="pull-left" href="javascript:;">
															<img class="todo-userpic" src="<?php echo $avatar; ?>" width="45px" height="45px">
														</a>
														<div class="media-body">
															<form class="note-form-ajax" enctype="multipart/form-data">
																<input type="hidden" name="lesson_id" value="<?php echo Hashids::encode($lesson->id); ?>"/>
																<input type="hidden" name="parent_id" value="<?php echo Hashids::encode(0); ?>"/>
																<div class="reply-textarea-content">
																	<textarea class="summernote" rows="1" placeholder="Escribe un comentario..." name="comment"></textarea>
																</div>
																<div class="reply-submit-btn">
																	<a href="javascript:;" class="pull-right btn btn-sm btn-circle green-haze note-form-btn"> &nbsp; Enviar &nbsp; </a>
																</div>
															</form>
														</div>
													</li>
												</ul>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>

					</div>
				</div>
				<!-- END PAGE CONTENT INNER -->
				
			</div>
					
			<!-- END PORTLET -->
		</div>
	</div>		

	<script type="text/javascript" src="/assets/global/plugins/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
	<script type="text/javascript" src="/assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.js"></script>

	<script type="text/javascript" src="/assets/global/plugins/bootstrap-wysihtml5/wysihtml5-0.3.0.js"></script>
	<script type="text/javascript" src="/assets/global/plugins/bootstrap-wysihtml5/bootstrap-wysihtml5.js"></script>
	<script src="/assets/global/plugins/bootstrap-markdown/lib/markdown.js" type="text/javascript"></script>
	<script src="/assets/global/plugins/bootstrap-markdown/js/bootstrap-markdown.js" type="text/javascript"></script>
	<script src="/assets/global/plugins/bootstrap-summernote/summernote.js" type="text/javascript"></script>

	<script type="text/javascript" src="/assets/global/plugins/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
	
	<script type="text/javascript">

		/**
		Comments Module
		**/

		var MomentManager = function(){

			var fromNow = function(){
				$('.moment-fromnow').each(function(e){
					var time = $(this).html();
					$(this).html(moment(time).fromNow());
					$(this).removeClass('moment-fromnow');
				});
			}

			return {

				init: function (){

					moment.locale('es');

					fromNow();

				}
			}
		}();

		var CommentsManager = function() {

			var display_comment = null;

			var image_loader = '<img src="/assets/loaders/rubiks-cube.gif" width="50px"/>';

			var generatePostForm = function(parent){

				var reply_form = '' +
				'<div class="media commenting">' +
					'<a class="pull-left" href="javascript:;">' +
						'<img class="todo-userpic" src="<?php echo Auth::user()->profile->getAvatar(); ?>" width="45px" height="45px">' +
					'</a>' +
					'<div class="media-body waiting_comment">' +
						'<form class="comment-form-ajax" enctype="multipart/form-data">' +
							'<input type="hidden" name="lesson_id" value="<?php echo Hashids::encode($lesson->id); ?>"/>' +
							'<input type="hidden" name="parent_id" value="' + parent + '"/>' +
							'<div class="reply-textarea-content">' +
								'<textarea class="summernote" rows="1" placeholder="Escribe un comentario..." name="comment"></textarea>' +
							'</div>' +
							'<div class="reply-submit-btn">' +
								'<button type="button" class="pull-right btn btn-sm btn-circle green-haze comment-reply-form-btn"> &nbsp; Responder &nbsp; </button>' +
								'<span class="pull-right"> &nbsp; </span>' +
								'<div class="pull-right fileinput fileinput-new" data-provides="fileinput">' +
									'<span class="btn default btn-file btn-sm btn-circle green-haze">' +
										'<span class="fileinput-new">AÃ±adir Adjunto </span>' +
										'<span class="fileinput-exists"> Cambiar </span>' +
										'<input type="file" name="attachment">' +
									'</span>' +
									'<span class="fileinput-filename"></span>&nbsp; ' +
									'<a href="#" class="close fileinput-exists" data-dismiss="fileinput"></a>' +
								'</div>' +
							'</div>' +
						'</form>' +
					'</div>' +
				'</div>';

				return reply_form;
				
			}

			var generatePutForm = function(comment, content){

				var reply_form = '' +
				'<div class="commenting" style="margin-bottom:30px">' +
					'<form class="comment-form-ajax" enctype="multipart/form-data">' +
						'<input type="hidden" name="lesson_id" value="<?php echo Hashids::encode($lesson->id); ?>"/>' +
						'<input type="hidden" name="comment_id" value="' + comment + '"/>' +
						'<div class="reply-textarea-content">' +
							'<textarea class="summernote" rows="1" placeholder="Escribe un comentario..." name="comment">' + content + '</textarea>' +
						'</div>' +
						'<div class="reply-submit-btn">' +
							'<button type="button" class="pull-right btn btn-sm btn-circle green-haze comment-put-btn"> &nbsp; Editar &nbsp; </button>' +
							'<span class="pull-right"> &nbsp; </span>' +
							'<!--<div class="pull-right fileinput fileinput-new" data-provides="fileinput">' +
								'<span class="btn default btn-file btn-sm btn-circle green-haze">' +
									'<span class="fileinput-new">AÃ±adir Adjunto </span>' +
									'<span class="fileinput-exists"> Cambiar </span>' +
									'<input type="file" name="attachment">' +
								'</span>' +
								'<span class="fileinput-filename"></span>&nbsp; ' +
								'<a href="#" class="close fileinput-exists" data-dismiss="fileinput"></a>' +
							'</div>-->' +
						'</div>' +
					'</form>' +
				'</div>';

				return reply_form;
				
			}

			var generatePutReplyForm = function(comment, content){

				var reply_form = '' +
				'<div class="media commenting" data-comment="' + comment + '">' +
					'<a class="pull-left" href="javascript:;">' +
						'<img class="todo-userpic" src="<?php echo Auth::user()->profile->getAvatar(); ?>" width="45px" height="45px">' +
					'</a>' +
					'<div class="media-body waiting_comment">' +
						'<form class="comment-form-ajax" enctype="multipart/form-data">' +
							'<input type="hidden" name="lesson_id" value="<?php echo Hashids::encode($lesson->id); ?>"/>' +
							'<input type="hidden" name="comment_id" value="' + comment + '"/>' +
							'<div class="reply-textarea-content">' +
								'<textarea class="summernote" rows="1" placeholder="Escribe un comentario..." name="comment">' + content + '</textarea>' +
							'</div>' +
							'<div class="reply-submit-btn">' +
								'<button type="button" class="pull-right btn btn-sm btn-circle green-haze comment-reply-put-btn"> &nbsp; Editar &nbsp; </button>' +
								'<span class="pull-right"> &nbsp; </span>' +
								'<!--<div class="pull-right fileinput fileinput-new" data-provides="fileinput">' +
									'<span class="btn default btn-file btn-sm btn-circle green-haze">' +
										'<span class="fileinput-new">AÃ±adir Adjunto </span>' +
										'<span class="fileinput-exists"> Cambiar </span>' +
										'<input type="file" name="attachment">' +
									'</span>' +
									'<span class="fileinput-filename"></span>&nbsp; ' +
									'<a href="#" class="close fileinput-exists" data-dismiss="fileinput"></a>' +
								'</div>-->' +
							'</div>' +
						'</form>' +
					'</div>' +
				'</div>';

				return reply_form;
				
			}

			var discussionsLike = function(el){

				var like = {
					user: '<?php echo Hashids::encode(Auth::user()->id); ?>',
					comment: 0
				};

				var reply_like = el.parents('div.media').data('comment');
				var comment_like = el.parents('li.media').data('comment');

				var parent = (typeof reply_like == "undefined") ? 'li.media' : 'div.media';
				like.comment = (typeof reply_like == "undefined") ? comment_like : reply_like;

				var comment_like_element = el.parents(parent).children('.media-body').children('.todo-comment-head').children('.comment-like-btn');

				comment_like_element.removeClass('font-blue-chambray');
				comment_like_element.removeClass('font-blue');
				comment_like_element.addClass('font-grey');

				$.ajax({
					url: '<?php echo $route; ?>/like',
					type: 'POST',
					dataType: 'json',
					data: like,
					async: true,
					success: function(data){
						// console.log(data);
						var counter = parseInt(comment_like_element.children('.thumbsups-counter').html());
						console.log(counter);
						var thumbsup_color = (data.thumbsup) ? 'font-blue' : 'font-blue-chambray';
						var thumbsup_counter = (data.thumbsup) ? counter+1 : counter-1;
						// console.log(thumbsup_counter);

						comment_like_element.attr('data-original-title', thumbsup_counter + ' Me gusta. ' + data.thumbsupers);
						comment_like_element.children('.thumbsups-counter').html(thumbsup_counter);
						comment_like_element.addClass(thumbsup_color);
						comment_like_element.removeClass('font-grey');
					},
					error: function(xhr){
						console.log(xhr);
					}
				});

				ComponentsEditors.init();
				MomentManager.init();
				Metronic.init();
				
			}

			var discussionsEdit = function(el){

				var data = {
					user: '<?php echo Hashids::encode(Auth::user()->id); ?>',
					comment: 0,
					content: '',
				};

				var reply_edit = el.parents('div.media').data('comment');
				var comment_edit = el.parents('li.media').data('comment');

				console.log(reply_edit);
				console.log(comment_edit);

				var parent = (typeof reply_edit == "undefined") ? 'li.media' : 'div.media';
				data.comment = (typeof reply_edit == "undefined") ? comment_edit : reply_edit;
				data.content = el.parents(parent).children('div.media-body').children('div.todo-text-color').html();

				if(typeof reply_edit == "undefined"){
					console.log('PARENT');
					var container = el.parents(parent).children('div.media-body');
					container.children('div.children-comments').before(generatePutForm(data.comment, data.content));
					container.children('p.todo-comment-head').remove();
					container.children('div.todo-text-color').remove();
				}
				else{
					el.parents(parent).html(generatePutReplyForm(data.comment, data.content));
				}

				ComponentsEditors.init();
				MomentManager.init();
				Metronic.init();
				
			}

			var discussionsDelete = function(el){

				var data = {
					user: '<?php echo Hashids::encode(Auth::user()->id); ?>',
					comment: 0
				};

				var reply_delete = el.parents('div.media').data('comment');
				var comment_delete = el.parents('li.media').data('comment');
				var master_container = el.parents('li.media');

				var parent = (typeof reply_delete == "undefined") ? 'li.media' : 'div.media';
				data.comment = (typeof reply_delete == "undefined") ? comment_delete : reply_delete;

				var container = el.parents(parent);
				var media_body = el.parents(parent).children('div.media-body');

				media_body.children('div.todo-text-color').html(image_loader);
				media_body.children('p.todo-comment-head').children('span.todo-comment-date').html('Eliminando');
				media_body.children('div.children-comments').remove();
				media_body.children('p.todo-comment-head').children('a').remove();


				$.ajax({
					url: '<?php echo $route; ?>/comments',
					type: 'DELETE',
					dataType: 'json',
					data: data,
					async: true,
					success: function(data){
						console.log(container);
						container.remove();
						if(typeof reply_delete != "undefined"){
							var replies = master_container.children('div.media-body').children('p.todo-comment-head').children('a.comment-reply-btn').children('span.replies-counter');
							console.log(replies);
							var counter =  parseInt(replies.html())-1;
							replies.html(counter);
						}
						console.log(data);
					},
					error: function(xhr){
						console.log(xhr);
					}
				});

				ComponentsEditors.init();
				MomentManager.init();
				Metronic.init();
				
			}

			var discussionsBan = function(el){

				var data = {
					user: '<?php echo Hashids::encode(Auth::user()->id); ?>',
					comment: 0
				};

				var reply_ban = el.parents('div.media').data('comment');
				var comment_ban = el.parents('li.media').data('comment');

				var parent = (typeof reply_ban == "undefined") ? 'li.media' : 'div.media';
				data.comment = (typeof reply_ban == "undefined") ? comment_ban : reply_ban;

				var container = el.parents(parent);

				if(container.hasClass('banned')){
					el.addClass('font-grey-silver');
					el.removeClass('font-red');
				}
				else{
					el.removeClass('font-grey-silver');
					el.addClass('font-red');
				}

				$.ajax({
					url: '<?php echo $route; ?>/banned',
					type: 'POST',
					dataType: 'json',
					data: data,
					async: true,
					success: function(data){
						if(data.banned){
							container.addClass('banned');
							container.remove();
							el.attr('data-original-title', 'Marcado como no deseado por ' + data.banneders );
						}
						else{
							container.remove();
							container.removeClass('banned');
							el.attr('data-original-title', 'Marcado como no deseado por ' + data.banneders);
							el.removeClass('font-grey-silver');
							el.addClass('font-red');
						}
						console.log(container);
						console.log(data);
					},
					error: function(xhr){
						console.log(xhr);
					}
				});

				ComponentsEditors.init();
				MomentManager.init();
				Metronic.init();
				
			}

			var discussionsReply = function(el){

				$('div.commenting').remove();

				var parent = el.parents('li.media').data('comment');

				console.log(parent);

				if($(el.parents('div.media-body').children('div.children-comments')).children('div.media').length > 0){
					$(el.parents('div.media-body').children('div.children-comments')).children('div.media:last').after(generatePostForm(parent));
				}
				else{
					$(el.parents('div.media-body')).children('div.children-comments').html(generatePostForm(parent));
				}

				$('#evaluation-form-loader').removeClass('hidden');

				ComponentsEditors.init();
				MomentManager.init();
				Metronic.init();
				
			}

			var discussionsReplySubmit = function(el){

				var form = $(el.parents('form.comment-form-ajax')[0]);

				var comment = $(form.children('div.reply-textarea-content')).children('textarea.summernote').val();

				var media_body = $(form.parents('div.media-body')[0]);

				reply_html = '' +
					'<p class="todo-comment-head">' +
						'<span class="todo-comment-username">' + '<?php echo Auth::user()->display_name; ?>' + '</span> &nbsp; ' +
						'<span class="todo-comment-date">Enviando</span> &nbsp; ' +
					'</p>' +
					'<div class="todo-text-color">' + image_loader + '</div>';

				media_body.html(reply_html);
				media_body.parents('div.media').removeClass('commenting');

				console.log(form.serialize());

				var formData = new FormData(el.parents('form.comment-form-ajax')[0]);

				$.ajax({
					url: '<?php echo $route; ?>/comments',
					type: 'POST',
					dataType: 'json',
					data: formData,
					async: true,
					success: function(data) {
						console.log(data);
						reply_html = '' +
							'<p class="todo-comment-head">' +
								'<span class="todo-comment-username">' + '<?php echo Auth::user()->display_name; ?>' + '</span> &nbsp; ' +
								'<span class="todo-comment-date moment-fromnow">' + data.created_at.date + '</span> &nbsp; ' + 
								( data.attachment != null ? '<a href="javascript:;" class="btn font-blue-chambray tooltips download-attachment-btn" data-original-title="Descargar archivo (' + data.attachment + ')" data-attachment="' + data.attachment_crypt + '"><i class="fa fa-paperclip"></i></a> &nbsp;' : '' ) +
								'<a href="javascript:;" class="btn font-blue-chambray tooltips comment-like-btn" data-original-title="0 Me gusta. "><i class="fa fa-thumbs-up"></i> <span class="thumbsups-counter">0</span></a> &nbsp; ' +
								'<a href="javascript:;" class="btn font-grey-silver tooltips comment-edit-btn pull-right" data-original-title="Editar"><i class="fa fa-pencil"></i></a>' +
								'<a href="javascript:;" class="btn font-grey-silver tooltips comment-delete-btn pull-right" data-original-title="Eliminar"><i class="fa fa-trash-o"></i></a>' +
							'</p>' +
							'<div class="todo-text-color">' +
								 comment +
							'</div>';

						var comment_element = $('div.waiting_comment');
						comment_element.html(reply_html);
						comment_element.removeClass('waiting_comment');
						comment_element.parents('div.media').attr('data-comment', data.id);

						var replies_tooltip = comment_element.parents('li.media').children('.media-body').children('.todo-comment-head').children('.comment-reply-btn');
						var replies = replies_tooltip.children('.replies-counter');
						var counter_replies = parseInt(replies.html())+1;
						replies.html(counter_replies);
						replies_tooltip.attr('data-original-title', counter_replies + ' Respuestas');
						console.log(counter_replies);

						MomentManager.init();
						Metronic.init();

					},
					error: function(xhr, status) {
						console.log(xhr);
						console.log(xhr.status);
					},
			        cache: false,
			        contentType: false,
			        processData: false
				});

			}

			var discussionsSubmit = function(el){

				var form = $(el.parents('form.comment-form-ajax')[0]);

				var comment = $(form.children('div.reply-textarea-content')).children('textarea.summernote').val();

				var media_body = form.parents('ul.media-list').children('li.media:last');

				// media_body.parents('div.media').removeClass('commenting');
				console.log(form.serialize());

				var formData = new FormData(el.parents('form.comment-form-ajax')[0]);

				comment_html = '' +
					'<li class="media waiting_comment">' +
						'<a class="pull-left" href="javascript:;">' +
						'<img class="todo-userpic" src="<?php echo Auth::user()->profile->getAvatar(); ?>" width="45px" height="45px">' +
						'</a>' +
						'<div class="media-body todo-comment">' +
							'<p class="todo-comment-head">' +
								'<span class="todo-comment-username"><?php echo Auth::user()->display_name; ?></span> &nbsp; <span class="todo-comment-date">Enviando</span> &nbsp;' +
							'</p>' +
							'<div class="todo-text-color" style="min-width:700px">' + image_loader + '</div>'
							'<div class="children-comments">' +
								'<!-- COMMENTS HERE -->' +
							'</div>' +
						'</div>' +
					'</li>';

				media_body.before(comment_html);

				$.ajax({
					url: '<?php echo $route; ?>/comments',
					type: 'POST',
					dataType: 'json',
					data: formData,
					async: true,
					success: function(data) {

						console.log(data);

						$('li.be-firts-comment').remove();

						comment_html = '' +
								'<a class="pull-left" href="javascript:;">' +
								'<img class="todo-userpic" src="<?php echo Auth::user()->profile->getAvatar(); ?>" width="45px" height="45px">' +
								'</a>' +
								'<div class="media-body todo-comment">' +
									'<p class="todo-comment-head">' +
										'<span class="todo-comment-username"><?php echo Auth::user()->display_name; ?></span> &nbsp; <span class="todo-comment-date moment-fromnow">' + data.created_at.date + '</span> &nbsp;' +
										( data.attachment != null ?	'<a href="javascript:;" class="btn font-blue-chambray tooltips download-attachment-btn" data-original-title="Descargar archivo (' + data.attachment + ')" data-attachment="' + data.attachment_crypt + '"><i class="fa fa-paperclip"></i></a> &nbsp;' : '' ) +
										'<a href="javascript:;" class="btn font-blue-chambray tooltips comment-like-btn" data-original-title="0 Me gusta"><i class="fa fa-thumbs-up"></i> <span class="thumbsups-counter">0</span></a> &nbsp; ' +
										'<a href="javascript:;" class="btn font-blue-chambray tooltips comment-reply-btn" data-original-title="0 Respuestas"><i class="fa fa-comments-o"></i> <span class="replies-counter">0</span></a>' +
										'<a href="javascript:;" class="btn font-grey-silver tooltips comment-edit-btn pull-right" data-original-title="Editar"><i class="fa fa-pencil"></i></a>' +
										'<a href="javascript:;" class="btn font-grey-silver tooltips comment-delete-btn pull-right" data-original-title="Eliminar"><i class="fa fa-trash-o"></i></a>' +
									'</p>' +
									'<div class="todo-text-color" style="min-width:700px">' + data.content + '</div>' +
									'<div class="children-comments">' +
										'<!-- COMMENTS HERE -->' +
									'</div>' +
								'</div>';

						var comment_element = $('li.waiting_comment');
						comment_element.html(comment_html);
						comment_element.data('comment', data.id);
						comment_element.removeClass('waiting_comment');
						console.log(data);

						el.parents('form.comment-form-ajax').children('div.reply-textarea-content').children('div.note-editor').children('div.note-editable').html('');

						MomentManager.init();
						Metronic.init();

					},
					error: function(xhr) {
						console.log(xhr);
					},
			        cache: false,
			        contentType: false,
			        processData: false
				});

			}

			var discussionsReplyPutSubmit = function(el){

				var form = $(el.parents('form.comment-form-ajax')[0]);

				var comment = $(form.children('div.reply-textarea-content')).children('textarea.summernote').val();

				var media_body = $(form.parents('div.media-body')[0]);

				reply_html = '' +
					'<p class="todo-comment-head">' +
						'<span class="todo-comment-username">' + '<?php echo Auth::user()->display_name; ?>' + '</span> &nbsp; ' +
						'<span class="todo-comment-date">Enviando</span> &nbsp; ' +
					'</p>' +
					'<div class="todo-text-color">' + image_loader + '</div>';

				media_body.html(reply_html);
				media_body.parents('div.media').removeClass('commenting');

				console.log(form.serialize());

				var formData = new FormData(el.parents('form.comment-form-ajax')[0]);

				$.ajax({
					url: '<?php echo $route; ?>/comments',
					type: 'PUT',
					dataType: 'json',
					data: form.serialize(),
					async: true,
					success: function(data) {

						console.log(data);

						reply_html = '' +
							'<p class="todo-comment-head">' +
								'<span class="todo-comment-username">' + '<?php echo Auth::user()->display_name; ?>' + '</span> &nbsp; ' +
								'<span class="todo-comment-date moment-fromnow">' + data.created_at.date + '</span> &nbsp; ' + 
								( data.attachment != null ? '<a href="javascript:;" class="btn font-blue-chambray tooltips" data-original-title="Descargar archivo (' + data.attachment + ')"><i class="fa fa-paperclip"></i></a> &nbsp;' : '' ) +
								'<a href="javascript:;" class="btn ' + (data.hasMyThumbsup ? 'font-blue' : 'font-blue-chambray' ) + ' tooltips comment-like-btn" data-original-title="' + data.thumbsups + ' Me gusta. ' + data.thumbsupers + '"><i class="fa fa-thumbs-up"></i> <span class="thumbsups-counter">' + data.thumbsups + '</span></a> &nbsp; ' +
								'<a href="javascript:;" class="btn font-grey-silver tooltips comment-edit-btn pull-right" data-original-title="Editar"><i class="fa fa-pencil"></i></a>' +
								'<a href="javascript:;" class="btn font-grey-silver tooltips comment-delete-btn pull-right" data-original-title="Eliminar"><i class="fa fa-trash-o"></i></a>' +
							'</p>' +
							'<div class="todo-text-color">' +
								 comment +
							'</div>';

						var comment_element = $('div.waiting_comment');
						comment_element.html(reply_html);
						comment_element.removeClass('waiting_comment');
						// comment_element.data('comment', data.id);

						MomentManager.init();
						Metronic.init();

					},
					error: function(xhr, status) {
						console.log(xhr);
						console.log(xhr.status);
					}
				});

			}

			var discussionsPutSubmit = function(el){

				var form = $(el.parents('form.comment-form-ajax')[0]);

				var comment = $(form.children('div.reply-textarea-content')).children('textarea.summernote').val();

				var media_body = el.parents('div.media-body');

				// media_body.parents('div.media').removeClass('commenting');
				console.log(form.serialize());

				var formData = new FormData(el.parents('form.comment-form-ajax')[0]);

				comment_html = '' +
					'<p class="todo-comment-head">' +
						'<span class="todo-comment-username"><?php echo Auth::user()->display_name; ?></span> &nbsp; <span class="todo-comment-date">Enviando</span> &nbsp;' +
					'</p>' +
					'<div class="todo-text-color" style="min-width:700px">' + image_loader + '</div>';

				media_body.children('div.children-comments').before(comment_html);
				media_body.children('div.commenting').remove();

				$.ajax({
					url: '<?php echo $route; ?>/comments',
					type: 'PUT',
					dataType: 'json',
					data: form.serialize(),
					async: true,
					success: function(data) {

						console.log(data);

						var todo_comment_head = '' +
							'<span class="todo-comment-username"><?php echo Auth::user()->display_name; ?></span> &nbsp; <span class="todo-comment-date moment-fromnow">' + data.created_at.date + '</span> &nbsp;' +
							( data.attachment != null ?	'<a href="javascript:;" class="btn font-blue-chambray tooltips" data-original-title="Descargar archivo (' + data.attachment + ')"><i class="fa fa-paperclip"></i></a> &nbsp;' : '' ) +
							'<a href="javascript:;" class="btn font-blue-chambray tooltips comment-like-btn" data-original-title="' + data.thumbsups + ' Me gusta. ' + data.thumbsupers + '"><i class="fa fa-thumbs-up"></i> <span class="thumbsups-counter">' + data.thumbsups + '</span></a> &nbsp; ' +
							'<a href="javascript:;" class="btn font-blue-chambray tooltips comment-reply-btn" data-original-title="' + data.replies + ' Respuestas"><i class="fa fa-comments-o"></i> <span class="replies-counter">' + data.replies + '</span></a>' +
							'<a href="javascript:;" class="btn font-grey-silver tooltips comment-edit-btn pull-right" data-original-title="Editar"><i class="fa fa-pencil"></i></a>' +
							'<a href="javascript:;" class="btn font-grey-silver tooltips comment-delete-btn pull-right" data-original-title="Eliminar"><i class="fa fa-trash-o"></i></a>';

						var todo_text_color = data.content;

						media_body.children('p.todo-comment-head').html(todo_comment_head);
						media_body.children('div.todo-text-color').html(todo_text_color);

						MomentManager.init();
						Metronic.init();

					},
					error: function(xhr) {
						console.log(xhr);
					}
				});

			}

			var updateSummernoteTextarea = function(el){

				var textarea = $($($(el.parents('div.note-editor')).siblings('textarea.summernote'))[0]);
				// console.log(el.html());
				// console.log(el.text());
				// console.log($.parseHTML(el.html()));
				textarea.html(el.html());

			}

		    var downloadAttachment = function (el) {

		        window.open('<?php echo $route; ?>/download?attachment=' + el.attr("data-attachment"));

		    }

			return {

				init: function (){

					$('.discussions').on('click', '.comment-reply-btn', function(event) {
						event.preventDefault();
						discussionsReply($(this));
						/* Act on the event */
					});

					$('.discussions').on('click', '.comment-like-btn', function(event) {
						event.preventDefault();
						discussionsLike($(this));
						/* Act on the event */
					});

					$('.discussions').on('click', '.comment-delete-btn', function(event) {
						event.preventDefault();
						discussionsDelete($(this));
						/* Act on the event */
					});

					$('.discussions').on('click', '.comment-edit-btn', function(event) {
						event.preventDefault();
						discussionsEdit($(this));
						/* Act on the event */
					});

					$('.discussions').on('click', '.comment-ban-btn', function(event) {
						event.preventDefault();
						discussionsBan($(this));
						/* Act on the event */
					});

					$('.discussions').on('click', '.comment-reply-form-btn', function(event) {
						event.preventDefault();
						discussionsReplySubmit($(this));
						/* Act on the event */
					});

					$('.discussions').on('click', '.comment-form-btn', function(event) {
						event.preventDefault();
						discussionsSubmit($(this));
						/* Act on the event */
					});

					$('.discussions').on('click', '.comment-reply-put-btn', function(event) {
						event.preventDefault();
						discussionsReplyPutSubmit($(this));
						/* Act on the event */
					});

					$('.discussions').on('click', '.comment-put-btn', function(event) {
						event.preventDefault();
						discussionsPutSubmit($(this));
						/* Act on the event */
					});

					$('.discussions').on('click', '.download-attachment-btn', function(event) {
						event.preventDefault();
						downloadAttachment($(this));
						/* Act on the event */
					});

					$('.discussions').on('keyup', '.note-editable', function(event) {
						event.preventDefault();
						updateSummernoteTextarea($(this));
						/* Act on the event */
					});

				}
			}

		}();

		var NotesManager = function() {

			var display_comment = null;

			var image_loader = '<img src="/assets/loaders/rubiks-cube.gif" width="50px"/>';

			var generatePutForm = function(comment, content){

				var reply_form = '' +
				'<div class="commenting" style="margin-bottom:30px">' +
					'<form class="note-form-ajax" enctype="multipart/form-data">' +
						'<input type="hidden" name="lesson_id" value="<?php echo Hashids::encode($lesson->id); ?>"/>' +
						'<input type="hidden" name="comment_id" value="' + comment + '"/>' +
						'<div class="reply-textarea-content">' +
							'<textarea class="summernote" rows="1" placeholder="Escribe un comentario..." name="comment">' + content + '</textarea>' +
						'</div>' +
						'<div class="reply-submit-btn">' +
							'<button type="button" class="pull-right btn btn-sm btn-circle green-haze note-put-btn"> &nbsp; Editar &nbsp; </button>' +
							'<span class="pull-right"> &nbsp; </span>' +
						'</div>' +
					'</form>' +
				'</div>';

				return reply_form;
				
			}

			var discussionsEdit = function(el){

				var data = {
					user: '<?php echo Hashids::encode(Auth::user()->id); ?>',
					note: 0,
					content: '',
				};

				var reply_edit = el.parents('div.media').data('note');
				var comment_edit = el.parents('li.media').data('note');

				// console.log(reply_edit);
				// console.log(comment_edit);

				data.note = el.parents('li.media').data('note');
				data.content = el.parents(parent).children('div.media-body').children('div.todo-text-color').html();

				console.log(data);
				var container = el.parents(parent).children('div.media-body');
				container.children('div.children-comments').before(generatePutForm(data.note, data.content));
				container.children('p.todo-comment-head').remove();
				container.children('div.todo-text-color').remove();

				ComponentsEditors.init();
				MomentManager.init();
				Metronic.init();
				
			}

			var discussionsDelete = function(el){

				var data = {
					user: '<?php echo Hashids::encode(Auth::user()->id); ?>',
					note: el.parents('li.media').data('note')
				};

				var master_container = el.parents('li.media');

				var parent = 'li.media';

				var container = el.parents(parent);
				var media_body = el.parents(parent).children('div.media-body');

				media_body.children('div.todo-text-color').html(image_loader);
				media_body.children('p.todo-comment-head').children('span.todo-comment-date').html('Eliminando');
				media_body.children('div.children-comments').remove();
				media_body.children('p.todo-comment-head').children('a').remove();


				$.ajax({
					url: '<?php echo $route; ?>/notes',
					type: 'DELETE',
					dataType: 'json',
					data: data,
					async: true,
					success: function(data){
						$('#my-notes-counter').html(parseInt($('#my-notes-counter').html()) - 1);
						console.log(container);
						container.remove();
						if(typeof reply_delete != "undefined"){
							var replies = master_container.children('div.media-body').children('p.todo-comment-head').children('a.comment-reply-btn').children('span.replies-counter');
							console.log(replies);
							var counter =  parseInt(replies.html())-1;
							replies.html(counter);
						}
						console.log(data);
					},
					error: function(xhr){
						console.log(xhr);
					}
				});

				ComponentsEditors.init();
				MomentManager.init();
				Metronic.init();
				
			}

			var discussionsSubmit = function(el){

				var form = $(el.parents('form.note-form-ajax')[0]);

				var comment = $(form.children('div.reply-textarea-content')).children('textarea.summernote').val();

				var media_body = form.parents('ul.media-list').children('li.media:last');

				// media_body.parents('div.media').removeClass('commenting');
				console.log(form.serialize());

				var formData = new FormData(el.parents('form.note-form-ajax')[0]);

				comment_html = '' +
					'<li class="media waiting_comment">' +
						'<a class="pull-left" href="javascript:;">' +
						'<img class="todo-userpic" src="<?php echo Auth::user()->profile->getAvatar(); ?>" width="45px" height="45px">' +
						'</a>' +
						'<div class="media-body todo-comment">' +
							'<p class="todo-comment-head">' +
								'<span class="todo-comment-username"><?php echo Auth::user()->display_name; ?></span> &nbsp; <span class="todo-comment-date">Enviando</span> &nbsp;' +
							'</p>' +
							'<div class="todo-text-color" style="min-width:700px">' + image_loader + '</div>'
							'<div class="children-comments">' +
								'<!-- COMMENTS HERE -->' +
							'</div>' +
						'</div>' +
					'</li>';

				media_body.before(comment_html);

				$.ajax({
					url: '<?php echo $route; ?>/notes',
					type: 'POST',
					dataType: 'json',
					data: formData,
					async: true,
					success: function(data) {

						$('#my-notes-counter').html(parseInt($('#my-notes-counter').html()) + 1);

						console.log(data);

						$('li.be-firts-comment').remove();

						comment_html = '' +
								'<a class="pull-left" href="javascript:;">' +
								'<img class="todo-userpic" src="<?php echo Auth::user()->profile->getAvatar(); ?>" width="45px" height="45px">' +
								'</a>' +
								'<div class="media-body todo-comment">' +
									'<p class="todo-comment-head">' +
										'<span class="todo-comment-username"><?php echo Auth::user()->display_name; ?></span> &nbsp; <span class="todo-comment-date moment-fromnow">' + data.created_at.date + '</span> &nbsp;' +
										'<a href="javascript:;" class="btn font-grey-silver tooltips note-edit-btn pull-right" data-original-title="Editar"><i class="fa fa-pencil"></i></a>' +
										'<a href="javascript:;" class="btn font-grey-silver tooltips note-delete-btn pull-right" data-original-title="Eliminar"><i class="fa fa-trash-o"></i></a>' +
									'</p>' +
									'<div class="todo-text-color" style="min-width:700px">' + data.content + '</div>' +
									'<div class="children-comments">' +
										'<!-- COMMENTS HERE -->' +
									'</div>' +
								'</div>';

						var comment_element = $('li.waiting_comment');
						comment_element.html(comment_html);
						comment_element.data('note', data.id);
						comment_element.removeClass('waiting_comment');
						console.log(data);

						el.parents('form.note-form-ajax').children('div.reply-textarea-content').children('div.note-editor').children('div.note-editable').html('');

						MomentManager.init();
						Metronic.init();

					},
					error: function(xhr) {
						console.log(xhr);
					},
			        cache: false,
			        contentType: false,
			        processData: false
				});

			}

			var discussionsPutSubmit = function(el){

				var form = $(el.parents('form.note-form-ajax')[0]);

				var comment = $(form.children('div.reply-textarea-content')).children('textarea.summernote').val();

				var media_body = el.parents('div.media-body');

				// media_body.parents('div.media').removeClass('commenting');
				console.log(form.serialize());

				var formData = new FormData(el.parents('form.ntoe-form-ajax')[0]);

				comment_html = '' +
					'<p class="todo-comment-head">' +
						'<span class="todo-comment-username"><?php echo Auth::user()->display_name; ?></span> &nbsp; <span class="todo-comment-date">Enviando</span> &nbsp;' +
					'</p>' +
					'<div class="todo-text-color" style="min-width:700px">' + image_loader + '</div>';

				media_body.children('div.children-comments').before(comment_html);
				media_body.children('div.commenting').remove();

				$.ajax({
					url: '<?php echo $route; ?>/notes',
					type: 'PUT',
					dataType: 'json',
					data: form.serialize(),
					async: true,
					success: function(data) {

						console.log(data);

						var todo_comment_head = '' +
							'<span class="todo-comment-username"><?php echo Auth::user()->display_name; ?></span> &nbsp; <span class="todo-comment-date moment-fromnow">' + data.created_at.date + '</span> &nbsp;' +
							'<a href="javascript:;" class="btn font-grey-silver tooltips comment-edit-btn pull-right" data-original-title="Editar"><i class="fa fa-pencil"></i></a>' +
							'<a href="javascript:;" class="btn font-grey-silver tooltips comment-delete-btn pull-right" data-original-title="Eliminar"><i class="fa fa-trash-o"></i></a>';

						var todo_text_color = data.content;

						media_body.children('p.todo-comment-head').html(todo_comment_head);
						media_body.children('div.todo-text-color').html(todo_text_color);

						MomentManager.init();
						Metronic.init();

					},
					error: function(xhr) {
						console.log(xhr);
					}
				});

			}

			var updateSummernoteTextarea = function(el){

				var textarea = $($($(el.parents('div.note-editor')).siblings('textarea.summernote'))[0]);
				// console.log(el.html());
				// console.log(el.text());
				// console.log($.parseHTML(el.html()));
				textarea.html(el.html());

			}

			var downloadNotes = function(el){

				var lesson = el.parents('.portlet').data('lesson');

		        window.open('<?php echo $route; ?>/notes?lesson_id=' + lesson);

			}

			return {

				init: function (){

					$('.notes').on('click', '.note-delete-btn', function(event) {
						event.preventDefault();
						discussionsDelete($(this));
						/* Act on the event */
					});

					$('.notes').on('click', '.note-edit-btn', function(event) {
						event.preventDefault();
						discussionsEdit($(this));
						/* Act on the event */
					});

					$('.notes').on('click', '.note-form-btn', function(event) {
						event.preventDefault();
						discussionsSubmit($(this));
						/* Act on the event */
					});

					$('.notes').on('click', '.note-put-btn', function(event) {
						event.preventDefault();
						discussionsPutSubmit($(this));
						/* Act on the event */
					});

					$('.notes').on('keyup', '.note-editable', function(event) {
						event.preventDefault();
						updateSummernoteTextarea($(this));
						/* Act on the event */
					});

					$('.tab-pane').on('click', '.notes-download-btn', function(event) {
						event.preventDefault();
						downloadNotes($(this));
						console.log("download");
						/* Act on the event */
					});

				}
			}

		}();

		var ActivitiesManager = function(){

			var showTesters = function(elem){

				var tester_list = $(elem).siblings('.testers');
				console.log(tester_list);
				if(tester_list.hasClass('hidden')){
					console.log('remove');
					tester_list.removeClass('hidden');
					elem.children('i').removeClass('fa-angle-double-down');
					elem.children('i').addClass('fa-angle-double-up');
				}
				else{
					console.log('add');
					tester_list.addClass('hidden');
					elem.children('i').removeClass('fa-angle-double-up');
					elem.children('i').addClass('fa-angle-double-down');
				}

			}

			return {

				init: function(){

					$('.testers-btn').click(function(event) {
						console.log('click');
						showTesters($(this));
					});

				}

			}

		}();

		var AttachmentsManager = function(){

		    var downloadAttachment = function (el) {

		        window.open('<?php echo $route; ?>/download?attachment=' + el.attr("data-attachment"));

		    }

			return {

				init: function(){

					$('.attachments').on('click', '.download-attachment-btn', function(event) {
						event.preventDefault();
						downloadAttachment($(this));
						/* Act on the event */
					});

				}

			}

		}();

		/**
		Todo Module
		**/
		var Todo = function () {

		    // private functions & variables

		    var _initComponents = function() {
		        
		        // init datepicker
		        $('.todo-taskbody-due').datepicker({
		            rtl: Metronic.isRTL(),
		            orientation: "left",
		            autoclose: true
		        });

		        // init tags        
		        $(".todo-taskbody-tags").select2({
		            tags: ["Testing", "Important", "Info", "Pending", "Completed", "Requested", "Approved"]
		        });
		    }

		    var _handleProjectListMenu = function() {
		        if (Metronic.getViewPort().width <= 992) {
		            $('.todo-project-list-content').addClass("collapse");
		        } else {
		            $('.todo-project-list-content').removeClass("collapse").css("height", "auto");
		        }
		    }

		    // public functions
		    return {

		        //main function
		        init: function () {
		            _initComponents();     
		            _handleProjectListMenu();

		            Metronic.addResizeHandler(function(){
		                _handleProjectListMenu();    
		            });       
		        }

		    };

		}();

		var ComponentsEditors = function () {

		    var handleSummernote = function () {
		        $('.summernote').summernote({
		        	height: 75,
		        });
		    }

		    return {
		        //main function to initiate the module
		        init: function () {
		            handleSummernote();
		        }
		    };

		}();

		var FancyboxManager = function () {

		    return {
		        //main function to initiate the module
		        init: function () {
		            $('.fancybox').fancybox();
		        }
		    };

		}();

		ComponentsEditors.init();
		Todo.init();
		CommentsManager.init();
		NotesManager.init();
		AttachmentsManager.init();
		ActivitiesManager.init();
		MomentManager.init();
		FancyboxManager.init();

		window.history.pushState("", "", '/coordinators/courses/show/<?php echo Hashids::encode($course->id); ?>?section=lessons&action=viewlesson&lesson_id=<?php echo Hashids::encode($lesson->id); ?>');
		document.title = 'Alyce | <?php echo $course->title; ?> | Contenido';

		$('#course-title').html('<?php echo $course->title; ?>');
		$('#course-teacher').html('<?php echo $course->teacher->display_name; ?>');
		$('#course-main-image').html('<img src="<?php echo $course->main_picture; ?>" class="img-responsive" alt="">');

	</script>